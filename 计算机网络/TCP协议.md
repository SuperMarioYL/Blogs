# TCP协议

<!-- TOC -->

- [TCP的数据包格式](#tcp的数据包格式)
- [TCP的三次握手](#tcp的三次握手)
  - [如果在第三次握手时失败会怎样？](#如果在第三次握手时失败会怎样)
- [TCP的四次挥手](#tcp的四次挥手)

<!-- /TOC -->

---
## TCP的数据包格式

TCP数据包的报文头有6位控制位:
- `ACK` 回应报文，握手和挥手使用
- `SYN` 握手使用
- `RST` 连接建立失败时使用
- `URG`
- `PSH`
- `FIN` 挥手时使用

![20200913205053](https://cdn.jsdelivr.net/gh/leiyu1997/ImageHostingService@master/resources/blogs/20200913205053.png)

---
## TCP的三次握手

主要流程如下：
1. 客户端接收到连接信息，向服务端发送SYN为1且数据为seq=x的报文，状态由关闭转为同步已发送
2. 服务端接收到客户端发来的报文后，状态由监听状态变为同步已接收，并向客户端发送SYN与ACK均为1，数据为seq=y且ack=x+1的报文
3. 客户端接收到服务端发来的信息以后，知道了客户端是可以传送到服务端的，于是将状态变为连接已建立，并向服务端发送ACK为1，数据为seq=x+1 ack=y+1的数据
4. 服务端收到客户端发回的数据后，知道客户端是可以接收到自己传的数据的，于是将状态变为连接已建立
5. 双方发送数据信息

如图所示：

![TCP三次握手](https://cdn.jsdelivr.net/gh/leiyu1997/ImageHostingService@master/resources/blogs/TCP三次握手.png)

### 如果在第三次握手时失败会怎样？

第三次握手失败时：
- 客户端认为建立了连接，从而向服务端发送数据
- 服务端没有收到信息，在等待一段时间后，会关闭连接防止SYN洪泛攻击
- 如果服务端接收到客户端的数据，会返回RST报文

---
## TCP的四次挥手